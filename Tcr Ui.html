<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TCR - Giao Di·ªán Ng∆∞·ªùi Ch∆°i</title>
  <style>
    body { font-family: Arial; text-align: center; background: #f0f0f0; }
    #timer, #mana, #towerHp { font-size: 1.5em; margin: 10px; }
    #status { font-size: 1.1em; margin: 10px; color: green; }
    #log { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; background: #fff; padding: 10px; margin: 10px; text-align: left; }
    button, input { padding: 10px; margin: 5px; }
    #game { display: none; }
    .troop-buttons { margin: 15px; display: none; }
    .troop-buttons button img { width: 32px; height: 32px; vertical-align: middle; margin-right: 5px; }
  </style>
</head>
<body>
  <h1>Clash Royale </h1>

  <div id="login">
    <input id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
    <input id="password" type="password" placeholder="M·∫≠t kh·∫©u">
    <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
    <div id="loginMsg"></div>
  </div>

  <div id="game">
    <div id="userInfo"></div>
    <div id="greeting"></div>
    <div id="status">Ch·ªù s·∫µn s√†ng...</div>
    <div id="timer">03:00</div>
    <div id="mana">Mana: 5</div>
    <div id="towerHp">M√°u tr·ª•: 100</div>
    <div><img id="towerImage" src="tower_large.png" width="100"></div>
    <button id="startBtn">S·∫µn S√†ng</button>

    <div class="troop-buttons">
      <button onclick="deployTroop('Pawn', 3)" data-cost="3"><img src="pawn_large.png">T·ªët</button>
      <button onclick="deployTroop('Bishop', 4)" data-cost="4"><img src="bishop_large.png">T∆∞·ª£ng</button>
      <button onclick="deployTroop('Rook', 5)" data-cost="5"><img src="rook_large.png">Xe</button>
      <button onclick="deployTroop('Knight', 5)" data-cost="5"><img src="knight_large.png">K·ªµ sƒ©</button>
      <button onclick="deployTroop('Prince', 6)" data-cost="6"><img src="prince_large.png">Ho√†ng t·ª≠</button>
      <button onclick="deployTroop('Queen', 5)" data-cost="5"><img src="queen_large.png">H·∫≠u</button>
    </div>
  </div>

  <div id="log"></div>

  <script>
    let socket = new WebSocket("ws://localhost:9001/ws");
    let ready = false, timeLeft = 180, mana = 5, towerHp = 100, timer, manaTimer;
    let currentUser = "";

    const troopDamage = {
      "Pawn": 3,
      "Bishop": 4,
      "Rook": 5,
      "Knight": 5,
      "Prince": 6,
      "Queen": 5
    };

    socket.onmessage = (event) => {
      let msg = JSON.parse(event.data);
      if (msg.type === 'login_success') {
        currentUser = msg.username;
        document.getElementById('login').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        document.querySelector('.troop-buttons').style.display = 'block';
        document.getElementById('userInfo').textContent = `üë§ ${msg.username} | Level ${msg.level} | EXP ${msg.exp}`;
        document.getElementById('greeting').textContent = `Xin ch√†o, ${msg.username}!`;

        // ƒê·ªïi m√†u cho player1/player2
        document.body.style.backgroundColor = (msg.username === 'player1') ? '#e0f7fa' : '#ffebee';
      } else if (msg.type === 'login_error') {
        document.getElementById('loginMsg').textContent = msg.message;
      } else if (msg.type === 'start') {
        logMessage('üî• Tr·∫≠n ƒë·∫•u b·∫Øt ƒë·∫ßu!');
        startCountdown();
        startManaRegen();
        resetTower();
      } else if (msg.type === 'action') {
        logMessage(`[${msg.time}] ${msg.detail}`);
        const words = msg.detail.split(":");
        if (words.length === 2) {
          let troopName = words[1].trim();
          let attacker = msg.detail.split(" ")[0];
          if (attacker !== currentUser) {
            let dmg = troopDamage[troopName] || 3;
            towerHp -= dmg;
            updateTowerHp();
            if (towerHp <= 30) {
              document.getElementById('towerImage').src = 'tower_damaged.png';
            }
          }
        }
      } else if (msg.type === 'result') {
        logMessage(`üèÅ ${msg.result}`);
        clearInterval(timer);
        clearInterval(manaTimer);
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').textContent = 'S·∫µn S√†ng l·∫°i';
        ready = false;
        timeLeft = 180;
        mana = 5;
        updateMana();
        resetTower();
        document.getElementById('timer').textContent = '03:00';
        document.getElementById('status').textContent = 'Ch·ªù s·∫µn s√†ng...';
        document.querySelector('.troop-buttons').style.display = 'block';
      }
    }

    socket.onclose = (e) => {
      logMessage(`‚ö†Ô∏è WebSocket ƒë√≥ng k·∫øt n·ªëi (${e.code})`);
      document.getElementById('status').textContent = '‚ùå M·∫•t k·∫øt n·ªëi t·ªõi m√°y ch·ªß';
    }

    setInterval(() => {
      if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ type: "ping" }));
      }
    }, 10000);

    function login() {
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      socket.send(JSON.stringify({ type: 'login', username: u, password: p }));
    }

    document.getElementById('startBtn').onclick = () => {
      if (!ready) {
        socket.send(JSON.stringify({ type: 'ready' }));
        document.getElementById('startBtn').disabled = true;
        ready = true;
      }
    }

    function deployTroop(troop, cost) {
      if (mana < cost) {
        logMessage(`‚ö†Ô∏è Kh√¥ng ƒë·ªß mana cho ${troop}`);
        return;
      }
      mana -= cost;
      updateMana();
      socket.send(JSON.stringify({ type: 'deploy', troop: troop }));
      logMessage(`üõ°Ô∏è ƒê√£ tri·ªÉn khai: ${troop}`);
    }

    function startCountdown() {
      timer = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          clearInterval(timer);
          clearInterval(manaTimer);
          document.getElementById('timer').textContent = '00:00';
          return;
        }
        let min = Math.floor(timeLeft / 60);
        let sec = timeLeft % 60;
        document.getElementById('timer').textContent = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
      }, 1000);
    }

    function startManaRegen() {
      manaTimer = setInterval(() => {
        if (mana < 10) {
          mana++;
          updateMana();
        }
      }, 1000);
    }

    function updateMana() {
      document.getElementById('mana').textContent = `Mana: ${mana}`;
    }

    function updateTowerHp() {
      if (towerHp < 0) towerHp = 0;
      document.getElementById('towerHp').textContent = `M√°u tr·ª•: ${towerHp}`;
    }

    function resetTower() {
      towerHp = 100;
      updateTowerHp();
      document.getElementById('towerImage').src = 'tower_large.png';
    }

    function logMessage(msg) {
      const entry = document.createElement('div');
      entry.textContent = msg;
      document.getElementById('log').appendChild(entry);
    }
  </script>
</body>
</html>
